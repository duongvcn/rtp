<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Welcome to RTP/RCTP Demo</title>
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="main.css?te=12">
</head>

<body>
    <header>
        <div class="topnav">
            <div class="title">HỆ THỐNG VIDEO CALL HỘI NGHỊ SỬ DỤNG GIAO THỨC RTP VÀ RTCP</div>
            <div id="buttons">
                <button class="mdc-button mdc-button--raised joinRoom">
                    <i class="material-icons mdc-button__icon" aria-hidden="true">perm_camera_mic</i>
                    <span class="mdc-button__label">Vào Phòng</span>
                </button>
                <button class="mdc-button mdc-button--raised loginBtn">
                    <i class="material-icons mdc-button__icon" aria-hidden="true">group</i>
                    <span class="mdc-button__label">Đăng Nhập</span>
                </button>
                <button class="mdc-button mdc-button--raised" id="hangupBtn">
                    <i class="material-icons mdc-button__icon" aria-hidden="true">close</i>
                    <span class="mdc-button__label">Thoát</span>
                </button>
                <button class="mdc-button mdc-button--raised deleteRoom">
                    <i class="material-icons mdc-button__icon" aria-hidden="true">close</i>
                    <span class="mdc-button__label">Xoá phòng</span>
                </button>
            </div>
        </div>
    </header>

    <div class="main-content ">
        <div class="rooms-div">
            <div class="roomName">
                <div class="room-header">
                    <div class="title">
                        DANH SÁCH PHÒNG HIỆN TẠI:
                    </div>
                    <button class="mdc-button mdc-button--raised addRoom">
                        <i class="material-icons mdc-button__icon" aria-hidden="true">group_add</i>
                        <span class="mdc-button__label">Thêm Phòng</span>
                    </button>
                </div>
                <ul class="rooms"></ul>

            </div>
        </div>
        <div id="videos">
            <div class="roomInfo"></div>
            <div class="video-view">
                <div class="relative">
                    <video id="localVideo" muted autoplay playsinline></video>
                    <div class="users"></div>
                </div>
                <div class="remoteVideo">
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="mdc-dialog" id="addRoom-dialog" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title"
        aria-describedby="my-dialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <h2 class="mdc-dialog__title" id="my-dialog-title">Tạo phòng</h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    Mã phòng:
                    <div class="mdc-text-field">
                        <input type="text" id="code" maxlength="8" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                    <br>
                    <br>
                    Tên Phòng:
                    <div class="mdc-text-field">
                        <input type="text" id="name" maxlength="255" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button id="addRoom" type="button" class="mdc-button mdc-dialog__button"
                        data-mdc-dialog-action="yes">
                        <span class="mdc-button__label">OK</span>
                    </button>
                </footer>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <div class="mdc-dialog" id="joinRoom-dialog" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title"
        aria-describedby="my-dialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <h2 class="mdc-dialog__title" id="my-dialog-title">Vào phòng</h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    Mã phòng:
                    <div class="mdc-text-field">
                        <input type="text" id="codeid" maxlength="8" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                    <br>
                    <br>
                    Tên User:
                    <div class="mdc-text-field">
                        <input type="text" id="nameuser" maxlength="255" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button id="joinRoom" type="button" class="mdc-button mdc-dialog__button"
                        data-mdc-dialog-action="yes">
                        <span class="mdc-button__label">OK</span>
                    </button>
                </footer>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <div class="mdc-dialog" id="login-dialog" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title"
        aria-describedby="my-dialog-content">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface">
                <h2 class="mdc-dialog__title" id="my-dialog-title">Admin Đăng Nhập</h2>
                <div class="mdc-dialog__content" id="my-dialog-content">
                    Nhập tên admin:
                    <div class="mdc-text-field">
                        <input type="text" id="username" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                    <br>
                    <br>
                    Nhập mật khẩu:
                    <div class="mdc-text-field">
                        <input type="password" id="password" class="mdc-text-field__input">
                        <div class="mdc-line-ripple"></div>
                    </div>
                </div>
                <footer class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button id="loginBtn" type="button" class="mdc-button mdc-dialog__button"
                        data-mdc-dialog-action="yes">
                        <span class="mdc-button__label">OK</span>
                    </button>
                </footer>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function interRoom(roomId) {
            $("#codeid").val(roomId);
            let admin = $("#adminName").html();
            if (admin && !!admin.trim()) {
                $("#nameuser").val(admin);
                setTimeout(() => {
                    $("#joinRoom").click();
                }, 200);
            } else {
                $(".joinRoom").click();
            }
        }
    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, remove, onChildAdded, onChildChanged, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCsVaScBoWw9UUZHFc2Dg4a-8bUcz7IoXs",
            authDomain: "video-e4342.firebaseapp.com",
            databaseURL: "https://video-e4342-default-rtdb.firebaseio.com",
            projectId: "video-e4342",
            storageBucket: "video-e4342.appspot.com",
            messagingSenderId: "174948062696",
            appId: "1:174948062696:web:33d1e6850ba036b1aa805d",
            measurementId: "G-HM145BRDTW"
        };


        // Initialize Firebase
        const firebaseApp = initializeApp(firebaseConfig);

        // Get a reference to the database service
        const firebaseDatabase = getDatabase(firebaseApp);
        let loginDialog = new mdc.dialog.MDCDialog(document.querySelector('#login-dialog'));
        let addRoomDialog = new mdc.dialog.MDCDialog(document.querySelector('#addRoom-dialog'));
        let joinRoomDialog = new mdc.dialog.MDCDialog(document.querySelector('#joinRoom-dialog'));
        let admin;
        let rooms = [];
        let users = [];
        let usersObj;
        let openRoomId;
        let attendee;
        const roomsRef = ref(firebaseDatabase, 'rooms');
        let currentRoomRef;
        $(".loginBtn").on("click", function (event) {
            loginDialog.open();
        });
        $(".addRoom").on("click", function (event) {
            addRoomDialog.open();
        });
        $(".joinRoom").on("click", function (event) {
            joinRoomDialog.open();
        });
        $("#loginBtn").on("click", function (event) {
            login();
        });
        $("#addRoom").on("click", function (event) {
            addRoom(admin);
        });
        $("#joinRoom").on("click", function (event) {
            let code = $("#codeid").val();
            let name = $("#nameuser").val();
            joinRoom(code, name);
        });
        $(".deleteRoom").on("click", function (event) {
            remove(ref(firebaseDatabase, 'rooms/' + openRoomId));
            closeCamera();
            for (var key in remoteStream) {
                remoteStream[key].getTracks().forEach(track => track.stop());
            }
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
        });

        $("#hangupBtn").on("click", function (event) {
            if (attendee) {
                remove(ref(firebaseDatabase, 'rooms/' + openRoomId + "/users/" + attendee));
            }
            $(".adminDelete").removeClass("adminDelete");
            getRooms();
            closeCamera();
        });
        function closeCamera() {
            const tracks = document.querySelector('#localVideo').srcObject.getTracks();
            if (tracks) {
                tracks.forEach(track => {
                    track.stop();
                });
            }
            $(".rooms-div").show();
            $("#videos").hide();
            $(".users").html('');
            $(".loginBtn").show();
            $(".joinRoom").show();
            $("#hangupBtn").hide();
        }

        function login() {
            let username = $("#username").val();
            let password = $("#password").val();
            get(ref(firebaseDatabase, 'admins'))
                .then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().find(x => x.name == username && x.password == password)) {
                        $(".loginBtn").hide();
                        $(".users").html(`Xin chào <span id="adminName">${username}</span>,`);
                        $(".addRoom").show();
                        $(".deleteRoom").addClass("adminDelete");
                        admin = username;
                    } else {
                        alert("Thông tin đăng nhập không đúng")
                    }
                });
        }
        function getRooms() {
            get(roomsRef).then((items) => {
                rooms = [];
                $(".rooms").html('');
                $.each(items.val(), function (i, item) {
                    rooms.push(item.id);
                    $(".rooms").append(`<li onclick="interRoom(${item.id})" class="item">
                        <h2>${item.name}</h2>
                        <div>Mã phòng: ${item.id}</div>
                        <div class="in-row"><span>Người tạo: ${item.createdBy} </span><span><i class="material-icons mdc-button__icon" aria-hidden="true">group</i><sup> ${item.users ? Object.keys(item.users).length : 0}</sup></span></div>
                        </li>`);
                });
            }).catch(handleError);
        }
        async function addRoom(username) {
            if (!username) return;
            const roomId = document.getElementById('code').value;
            const roomName = document.getElementById('name').value;
            if (rooms.includes(roomId)) {
                alert("Mã phòng đã tồn tại.");
            } else {
                let roomRef = ref(firebaseDatabase, 'rooms/' + roomId);
                set(roomRef, {
                    "createdBy": username,
                    "name": roomName,
                    "id": roomId
                }).then((snapshot) => {
                    alert("Tạo phòng thành công");
                    getRooms(username);
                }).catch(handleError);
            }
        }
        function joinRoom(code, name) {
            attendee = name;
            openRoomId = code;
            loadUsers(code)
            setTimeout(() => {
                joinRoomValid(code, name)
            }, 300)
        }
        function joinRoomValid(code, name) {
            if (users.includes(name)) {
                alert("Tên user đang tồn tại trong meeting!")
            } else {
                currentRoomRef = ref(firebaseDatabase, 'rooms/' + openRoomId);
                get(currentRoomRef).then((item) => {
                    if (item.exists()) {
                        $(".loginBtn").hide();
                        $(".joinRoom").hide();
                        $("#hangupBtn").show();
                        joinVideoCall(code, name);
                        $("#videos").show();
                        $(".rooms-div").hide();
                        $(".users").html(`${name}`);
                        let room = item.val();
                        $(".adminDelete").show();
                        $(".roomInfo").html(`<label class="uppr">${room.name}</label><label> ID: ${room.id}</label><label> Người tạo: ${room.createdBy}</label>`);
                    } else {
                        alert("Phòng không tồn tại")
                    }
                }).catch(handleError);
            }
        }
        function handleError(error) {
            console.error('Error: ', error);
        }
        function loadUsers(roomId) {
            const usersRef = ref(firebaseDatabase, 'rooms/' + roomId + "/users");
            $(".remoteVideo").html('')
            get(usersRef)
                .then((snapshot) => {
                    let data = snapshot.val();
                    users = []
                    usersObj = data;
                    for (var key in data) {
                        if (!users.includes(key)) {
                            users.push(key);
                            if (key !== attendee) {
                                $(".remoteVideo").append(`<div class="video-item ${key}"><video id="${data[key].mediaId}" autoplay playsinline></video><span class="video-name">${key}</span></div>`);
                            }
                        }
                    }
                })
        }
        
        function updateUsers(roomId) {
            const usersRef = ref(firebaseDatabase, 'rooms/' + roomId + "/users");
            get(usersRef)
                .then((snapshot) => {
                    let data = snapshot.val();
                    let temp = [];

                    for (var key in data) {
                        temp.push(key);
                    }
                    let removed = users.filter(function (item) {
                        return !temp.includes(item);
                    });
                    let added = temp.filter(function (item) {
                        return !users.includes(item);
                    });
                    removed.forEach(item => {
                        $(`.remoteVideo .${item}`).remove();
                    })
                    added.forEach(key => {
                        if (key !== attendee) {
                            $(".remoteVideo").append(`<div class="video-item ${key}"><video id="${data[key].mediaId}" autoplay playsinline></video><span class="video-name">${key}</span></div>`);
                        }
                    })
                    users = temp;
                })
        }

        let peerConnection = null;
        let localStream = null;
        let roomId = null;
        let remoteStream = {};
        let inCall = false;
        const configuration = {
            iceServers: [
                {
                    urls: [
                        'stun:stun1.l.google.com:19302',
                        'stun:stun2.l.google.com:19302',
                    ],
                },
            ],
            iceCandidatePoolSize: 10,
            encodedInsertableStreams: true,
        };

        $(document).ready(function () {
            getRooms();
        });

        onChildChanged(ref(firebaseDatabase, 'rooms/'), (data) => {
            getRooms();
        });

        setInterval(() => {
            if (!inCall) return;
            updateUsers(openRoomId);
        }, 1500)

        async function joinVideoCall(roomId, username) {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.querySelector('#localVideo').srcObject = stream;
            localStream = stream;
            createPeerConnection(roomId, username);
            addTracksToPeerConnection(localStream);
            // createOffer();
            onChildChanged(ref(firebaseDatabase, 'rooms/' + openRoomId + "/users/"), (data) => {
                console.log("onChildChanged users", data.val());
                loadUsers(openRoomId);
            });
            inCall = true;
        }

        function addUpdateUser(name, msg, id) {
            let userRef = ref(firebaseDatabase, 'rooms/' + openRoomId + "/users/" + name);
            set(userRef, { sender: name, message: msg, mediaId: id });
        }

        window.addEventListener('beforeunload', function (event) {
            var confirmationMessage = 'Are you sure you want to leave?';
            (event || window.event).returnValue = confirmationMessage;
            if (confirmationMessage) {
                $("#hangupBtn").click();
            }
            return confirmationMessage;
        });

        function createPeerConnection(roomId, username) {
            peerConnection = new RTCPeerConnection();

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate:', event.candidate);
                    addUpdateUser(username, JSON.stringify({ 'ice': event.candidate }), localStream.id);
                }
            };
            // peerConnection.addEventListener('track', gotRemoteStream);
            peerConnection.ontrack = (event => {
                console.log("ontrack", event.streams[0]);
                let stream = event.streams[0];
                let remoteVideo = document.getElementById(stream.id);
                if (!remoteVideo) {
                    loadUsers(openRoomId);
                }
                setTimeout(() => {
                    remoteVideo = document.getElementById(stream.id)
                    console.log(remoteVideo, stream);
                    if (remoteVideo) {
                        remoteVideo.srcObject = stream;
                    }
                }, 500);
            });

            peerConnection.onaddstream = (event) => {
                addStream(event.stream);
                // remoteVideo.srcObject = event.stream;
                console.log("onaddstream", event);
                let stream = event.stream;
                let remoteVideo = document.getElementById(stream.id);
                if (!remoteVideo) {
                    loadUsers(openRoomId);
                }
                setTimeout(() => {
                    remoteVideo = document.getElementById(stream.id)
                    console.log(remoteVideo, stream);
                    if (remoteVideo) {
                        remoteVideo.srcObject = stream;
                    }
                }, 500);
            };

            peerConnection.oniceconnectionstatechange = (event) => {
                console.log('ICE connection state:', peerConnection.iceConnectionState);
            };

            peerConnection.onnegotiationneeded = () => {
                createOffer();
            };
        }

        function addTracksToPeerConnection(stream) {
            // peerConnection.addStream(stream);
            stream.getTracks().forEach(track => {
                peerConnection.addTrack(track, stream);
            });
        }

        function createOffer() {
            peerConnection.createOffer()
                .then(offer => {
                    peerConnection.setLocalDescription(offer);
                    // Send the offer to the other peer
                    console.log('Sending offer:', offer);
                    addUpdateUser(attendee, JSON.stringify({ 'sdp': peerConnection.localDescription }), localStream.id);
                })
                .catch(error => {
                    console.error('Error creating offer:', error);
                });
        }
    </script>
</body>

</html>